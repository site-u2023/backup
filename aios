#!/bin/sh
# License: CC0
# OpenWrt >= 19.07
#
# aios メインスクリプト
#
echo aios Last update: 20250205-4

# 定数の設定
BASE_URL="https://raw.githubusercontent.com/site-u2023/aios/main"
BASE_DIR="/tmp/aios"
SUPPORTED_VERSIONS="19.07 21.02 22.03 23.05 24.10.0 SNAPSHOT"
SUPPORTED_LANGUAGES="en ja zh-cn zh-tw id ko de ru"
INPUT_LANG="$1"

#########################################################################
# 共通エラー処理
#########################################################################
handle_error() {
    echo -e "\033[1;31mERROR:\033[0m $1"
    echo "Log file: ${BASE_DIR}/aios_error.log"
    exit 1
}

#########################################################################
# ディレクトリの初期化と作成
#########################################################################
initialize_environment() {
    echo -e "\033[1;34mInitializing environment...\033[0m"
    rm -rf "$BASE_DIR"
    mkdir -p "$BASE_DIR" || handle_error "Failed to create directory: $BASE_DIR"
}

#########################################################################
# 汎用ファイルダウンロード関数
# 引数: $1 = ダウンロード先ファイル名, $2 = リモートファイル名
#########################################################################
download_script() {
    local filename="$1"
    local remote="$2"
    wget --quiet -O "${BASE_DIR}/${filename}" "${BASE_URL}/${remote}" || handle_error "Failed to download ${remote}"
}

download_version_db() {
    wget --quiet -O "${BASE_DIR}/supported_versions.db" "${BASE_URL}/supported_versions.db" || handle_error "Failed to download supported_versions.db"
}

#########################################################################
# 言語設定の確認と選択 (ash 対応版)
#########################################################################
check_language() {
    if [ -f "${BASE_DIR}/language_cache" ]; then
        SELECTED_LANGUAGE=$(cat "${BASE_DIR}/language_cache")
    else
        echo -e "\033[1;32mSelect your language:\033[0m"
        index=1
        for lang in $SUPPORTED_LANGUAGES; do
            echo "$index) $lang"
            index=$((index + 1))
        done

        read -p "Enter the number corresponding to your language: " lang_choice
        lang_selected=$(echo $SUPPORTED_LANGUAGES | awk -v num="$lang_choice" '{print $num}')

        if echo "$SUPPORTED_LANGUAGES" | grep -qw "$lang_selected"; then
            SELECTED_LANGUAGE="$lang_selected"
            echo "$SELECTED_LANGUAGE" > "${BASE_DIR}/language_cache"
        else
            echo -e "\033[1;31mInvalid selection. Defaulting to English (en).\033[0m"
            SELECTED_LANGUAGE="en"
            echo "$SELECTED_LANGUAGE" > "${BASE_DIR}/language_cache"
        fi
    fi
}

#########################################################################
# バナー表示関数
#########################################################################
banner() {
    local lang="${SELECTED_LANGUAGE:-en}"
    local msg disclaimer all_in_one

    case "$lang" in
        ja)  msg="オープンダブルアールティー専用設定ソフトウェア"; disclaimer="免責事項: 本スクリプトは自己責任でご使用下さい"; all_in_one="オールインワンスクリプト" ;;
        zh-cn) msg="欧鹏达布里阿尔提封装配置软件"; disclaimer="声明: 使用本脚本风险自承"; all_in_one="全面集成脚本" ;;
        en|*) msg="Dedicated configuration software for OpenWrt"; disclaimer="Disclaimer: Use this script at your own risk"; all_in_one="All-in-One Scripts" ;;
    esac

    echo
    echo -e "\033[1;35m                    ii i                              \033[0m"
    echo -e "\033[1;34m         aaaa      iii       oooo      sssss          \033[0m"
    echo -e "\033[1;36m            aa      ii      oo  oo    ss              \033[0m"
    echo -e "\033[1;32m         aaaaa      ii      oo  oo     sssss          \033[0m"
    echo -e "\033[1;33m        aa  aa      ii      oo  oo         ss         \033[0m"
    echo -e "\033[1;31m         aaaaa     iiii      oooo     ssssss          \033[0m"
    echo
    echo -e "\033[1;37m$msg\033[0m"
    echo -e "\033[1;37m$all_in_one\033[0m"
    echo -e "\033[1;41m$disclaimer\033[0m"
}

#########################################################################
# OpenWrt 設定スクリプトの実行
#########################################################################
execute_openwrt_config() {
    sh "${BASE_DIR}/openwrt-config.sh" || handle_error "Failed to execute openwrt-config.sh"
}

#########################################################################
# メイン処理
#########################################################################
initialize_environment
download_script "common-functions.sh" "common-functions.sh"
. "${BASE_DIR}/common-functions.sh"  # 共通関数を読み込み

check_version || handle_error "Unsupported OpenWrt version detected."
check_language
banner
download_script "country-zone.sh" "country-zone.sh"
download_script "openwrt-config.sh" "openwrt-config.sh"
execute_openwrt_config
