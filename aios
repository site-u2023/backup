#!/bin/sh
# License: CC0
# OpenWrt >= 19.07
#
# aios メインスクリプト
AIOS_VERSION="2025.02.05-rc1"
echo "aios Last update: $AIOS_VERSION"

# === 定数の設定 ===
BASE_URL="https://raw.githubusercontent.com/site-u2023/aios/main"
BASE_DIR="/tmp/aios"
SUPPORTED_LANGUAGES="en ja zh-cn zh-tw id ko de ru"
INPUT_LANG="$1"

#########################################################################
# 共通エラー処理
#########################################################################
handle_error() {
    echo -e "\033[1;31mERROR:\033[0m $1"
    echo "Log file: ${BASE_DIR}/aios_error.log"
    exit 1
}

#########################################################################
# 環境の初期化
#########################################################################
initialize_environment() {
    echo -e "\033[1;34m$(get_message 'MSG_DOWNLOAD_START' "$SELECTED_LANGUAGE")\033[0m"
    mkdir -p "$BASE_DIR" || handle_error "$(get_message 'MSG_DOWNLOAD_FAIL' "$SELECTED_LANGUAGE")"
}

#########################################################################
# 共通関数の読み込み
#########################################################################
load_common_functions() {
    if [ ! -f "${BASE_DIR}/common-functions.sh" ]; then
        wget --quiet -O "${BASE_DIR}/common-functions.sh" "${BASE_URL}/common-functions.sh" || handle_error "Failed to download common-functions.sh"
    fi
    . "${BASE_DIR}/common-functions.sh" || handle_error "Failed to source common-functions.sh"
}

#########################################################################
# バージョン確認
#########################################################################
verify_version() {
    check_version_common || handle_error "$(get_message 'MSG_VERSION_UNSUPPORTED' "$SELECTED_LANGUAGE")"
}

#########################################################################
# 言語設定
#########################################################################
setup_language() {
    if [ -n "$INPUT_LANG" ] && echo "$SUPPORTED_LANGUAGES" | grep -qw "$INPUT_LANG"; then
        SELECTED_LANGUAGE="$INPUT_LANG"
        echo "$SELECTED_LANGUAGE" > "${BASE_DIR}/language_cache"
    else
        check_language_common
    fi
    echo -e "\033[1;32m$(get_message 'MSG_SETTINGS_APPLIED' "$SELECTED_LANGUAGE")\033[0m"
}

#########################################################################
# バナー表示
#########################################################################
print_banner() {
    local banner_msg
    banner_msg=$(get_message 'MSG_BANNER' "$SELECTED_LANGUAGE")
    echo -e "\033[1;36m${banner_msg}\033[0m"
}

#########################################################################
# OpenWrt 設定スクリプトの実行
#########################################################################
execute_openwrt_config() {
    if [ ! -f "${BASE_DIR}/openwrt-config.sh" ]; then
        download_file "${BASE_URL}/openwrt-config.sh" "${BASE_DIR}/openwrt-config.sh"
    fi
    sh "${BASE_DIR}/openwrt-config.sh" || handle_error "$(get_message 'MSG_EXECUTE_AIOS_FAIL' "$SELECTED_LANGUAGE")"
}

#########################################################################
# メイン処理
#########################################################################
initialize_environment
load_common_functions
verify_version
setup_language
print_banner
execute_openwrt_config
