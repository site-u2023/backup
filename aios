#!/bin/sh
# License: CC0
# OpenWrt >= 19.07

BASE_URL="https://raw.githubusercontent.com/site-u2023/aios/main/"
BASE_DIR="/tmp/aios/"
SUPPORTED_VERSIONS="19 21 22 23 24 SN"

xxxbanner() {
    local lang="${SELECTED_LANGUAGE:-en}"
    local msg disclaimer

    if [ "$lang" = "en" ]; then
        msg="    Dedicated configuration software for OpenWrt.     "
        disclaimer="    Disclaimer: Use this script at your own risk.     "
        all_in_one="                  all in one scripts                  "
    elif [ "$lang" = "ja" ]; then
        msg="              OpenWrt 専用設定ソフトウェア              "
        disclaimer="      免責事項: 本スクリプトは自己責任でご使用下さい      "
        all_in_one="                オールインワンスクリプト                "
    fi
    echo -e "$(color "white"     "$msg")"
    echo -e "$(color "white"     "                                                      ")"
    echo -e "$(color "magenta"   "                    ii i                              ")"
    echo -e "$(color "blue"      "         aaaa      iii       oooo      sssss          ")"
    echo -e "$(color "cyan"      "            aa      ii      oo  oo    ss              ")"
    echo -e "$(color "green"     "         aaaaa      ii      oo  oo     sssss          ")"
    echo -e "$(color "yellow"    "        aa  aa      ii      oo  oo         ss         ")"
    echo -e "$(color "red"       "         aaaaa     iiii      oooo     ssssss          ")"
    echo -e "$(color "white"     "                                                      ")"
    echo -e "$(color "white"     "$all_in_one                                           ")"
    echo -e "$(color "white"     "                                                      ")"
    echo -e "$(color "red_white" "$disclaimer")"
}

center_align() {
    local width="$1"
    local text="$2"
    local text_length
    local padding

    text_length=${#text}
    padding=$(( (width - text_length) / 2 ))

    printf "%*s%s%*s\n" $((padding + text_length)) "$text" $((width - text_length - padding)) ""
}

banner() {
    local lang="${SELECTED_LANGUAGE:-en}"
    local msg disclaimer all_in_one
    local width=54  # 中央揃えのための幅

    # メッセージの設定
    if [ "$lang" = "en" ]; then
        msg="Dedicated configuration software for OpenWrt."
        disclaimer="Disclaimer: Use this script at your own risk."
        all_in_one="all in one scripts"
    elif [ "$lang" = "ja" ]; then
        msg="OpenWrt 専用設定ソフトウェア"
        disclaimer="免責事項: 本スクリプトは自己責任でご使用下さい"
        all_in_one="オールインワンスクリプト"
    fi

    # バナー表示部分（中央揃え）
    center_align $width "$(color "white" "    $msg    ")"
    center_align $width "$(color "white" "                                                      ")"
    center_align $width "$(color "magenta" "                    ii i                              ")"
    center_align $width "$(color "blue" "         aaaa      iii       oooo      sssss          ")"
    center_align $width "$(color "cyan" "            aa      ii      oo  oo    ss              ")"
    center_align $width "$(color "green" "         aaaaa      ii      oo  oo     sssss          ")"
    center_align $width "$(color "yellow" "        aa  aa      ii      oo  oo         ss         ")"
    center_align $width "$(color "red" "         aaaaa     iiii      oooo     ssssss          ")"
    center_align $width "$(color "white" "                                                      ")"
    center_align $width "$(color "white" "    $all_in_one    ")"
    center_align $width "$(color "white" "                                                      ")"
    center_align $width "$(color "red_white" "    $disclaimer    ")"
}


make_directory() {
    if [ ! -d "$BASE_DIR" ]; then
        mkdir -p "$BASE_DIR" || { echo "Failed to create BASE_DIR"; exit 1; }
    fi
}

download_and_execute_common() {
    wget --no-check-certificate --quiet -O "${BASE_DIR%/}/common-functions.sh" "${BASE_URL}common-functions.sh" || {
        echo "Failed to download common-functions.sh"
        exit 1
    }
    source "${BASE_DIR%/}/common-functions.sh" || {
        echo "Failed to source common-functions.sh"
        exit 1
    }
}

download_openwrt_config() {
    wget --no-check-certificate --quiet -O "${BASE_DIR%/}/openwrt-config.sh" "${BASE_URL}openwrt-config.sh" || {
        echo "Failed to download openwrt-config.sh"
        exit 1
    }
}

execute_openwrt_config() {
    sh "${BASE_DIR%/}/openwrt-config.sh" || {
        echo "Failed to execute openwrt-config.sh"
        exit 1
    }
}

delete_language
make_directory
download_and_execute_common
check_common "$1"
download_openwrt_config
banner
execute_openwrt_config
